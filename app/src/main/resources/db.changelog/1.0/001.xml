<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.3.xsd">

    <changeSet id="1-create-role-table" author="dev">
        <createTable tableName="role">
            <column name="id" type="INT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="VARCHAR(255)"/>
            <column name="description" type="TEXT"/>
        </createTable>
    </changeSet>

    <changeSet id="2-create-plan-table" author="dev">
        <createTable tableName="plan">
            <column name="id" type="INT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="VARCHAR(255)"/>
            <column name="description" type="TEXT"/>
            <column name="price" type="DECIMAL(10,2)"/>
            <column name="max_users" type="INT" defaultValueNumeric="0"/>
            <column name="max_realms" type="INT" defaultValueNumeric="0"/>
            <column name="features" type="TEXT"/>
        </createTable>
    </changeSet>

    <changeSet id="3-create-company-table" author="dev">
        <createTable tableName="company">
            <column name="id" type="INT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="VARCHAR(255)"/>
            <column name="description" type="TEXT"/>
            <column name="domain" type="VARCHAR(255)"/>
            <column name="email" type="VARCHAR(255)">
                <constraints unique="true"/>
            </column>
            <column name="phone" type="VARCHAR(50)"/>
            <column name="address" type="TEXT"/>
            <column name="city" type="VARCHAR(100)"/>
            <column name="state" type="VARCHAR(100)"/>
            <column name="country" type="VARCHAR(100)"/>
            <column name="postal_code" type="VARCHAR(20)"/>
            <column name="website" type="VARCHAR(255)"/>
            <column name="enabled" type="BOOLEAN"/>
            <column name="verified" type="BOOLEAN"/>
            <column name="sso_enabled" type="BOOLEAN"/>
            <column name="subscription_status" type="VARCHAR(50)"/>
            <column name="trial_ends_at" type="DATETIME"/>
            <column name="subscription_ends_at" type="DATETIME"/>
            <column name="logo_url" type="VARCHAR(500)"/>
            <column name="siret" type="VARCHAR(14)"/>
            <column name="vat" type="VARCHAR(20)"/>
            <column name="plan_id" type="INT">
                <constraints nullable="false" foreignKeyName="fk_company_plan" referencedTableName="plan" referencedColumnNames="id"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="4-create-user-table" author="dev">
        <createTable tableName="user">
            <column name="id" type="INT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="username" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="email" type="VARCHAR(255)">
                <constraints unique="true"/>
            </column>
            <column name="enabled" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="firstname" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="lastname" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="password" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="verified_at" type="DATETIME"/>
            <column name="company_id" type="INT">
                <constraints nullable="false" foreignKeyName="fk_user_company" referencedTableName="company" referencedColumnNames="id"/>
            </column>
            <column name="role_id" type="INT">
                <constraints nullable="false" foreignKeyName="fk_user_role" referencedTableName="role" referencedColumnNames="id"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="5-create-realm-table" author="dev">
        <createTable tableName="realm">
            <column name="id" type="INT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="enabled" type="BOOLEAN"/>
            <column name="company_id" type="INT">
                <constraints nullable="false" foreignKeyName="fk_realm_company" referencedTableName="company" referencedColumnNames="id"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="6-create-user-realm-table" author="dev">
        <createTable tableName="user_realm">
            <column name="realm_id" type="INT">
                <constraints nullable="false" foreignKeyName="fk_userrealm_realm" referencedTableName="realm" referencedColumnNames="id"/>
            </column>
            <column name="user_id" type="INT">
                <constraints nullable="false" foreignKeyName="fk_userrealm_user" referencedTableName="user" referencedColumnNames="id"/>
            </column>
            <column name="added_at" type="DATETIME"/>
            <column name="last_access" type="DATETIME"/>
            <constraints primaryKey="true" primaryKeyName="pk_user_realm" primaryKeyColumns="realm_id, user_id"/>
        </createTable>
    </changeSet>

    <changeSet id="7-create-user-role-table" author="dev">
        <createTable tableName="user_role">
            <column name="role_id" type="INT">
                <constraints nullable="false" foreignKeyName="fk_userrole_role" referencedTableName="role" referencedColumnNames="id"/>
            </column>
            <column name="user_id" type="INT">
                <constraints nullable="false" foreignKeyName="fk_userrole_user" referencedTableName="user" referencedColumnNames="id"/>
            </column>
            <column name="assigned_at" type="DATETIME"/>
            <constraints primaryKey="true" primaryKeyName="pk_user_role" primaryKeyColumns="role_id, user_id"/>
        </createTable>
        <addUniqueConstraint tableName="user_role" columnNames="user_id" constraintName="uq_user_role_user"/>
    </changeSet>

    <changeSet id="8-create-user-session-table" author="dev">
        <createTable tableName="user_session">
            <column name="id" type="INT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="user_id" type="INT">
                <constraints foreignKeyName="fk_session_user" referencedTableName="user" referencedColumnNames="id"/>
            </column>
            <column name="realm_id" type="INT">
                <constraints foreignKeyName="fk_session_realm" referencedTableName="realm" referencedColumnNames="id"/>
            </column>
            <column name="session_token" type="VARCHAR(512)">
                <constraints nullable="false"/>
            </column>
            <column name="refresh_token" type="VARCHAR(512)"/>
            <column name="ip" type="VARCHAR(45)"/>
            <column name="ua" type="TEXT"/>
            <column name="expires_at" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="revoked" type="BOOLEAN"/>
        </createTable>
    </changeSet>

    <changeSet id="9-create-email-verification-token-table" author="dev">
        <createTable tableName="email_verification_token">
            <column name="id" type="INT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="token" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="expires_at" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="used" type="BOOLEAN"/>
            <column name="user_id" type="INT">
                <constraints foreignKeyName="fk_emailtoken_user" referencedTableName="user" referencedColumnNames="id"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="10-create-password-reset-token-table" author="dev">
        <createTable tableName="password_reset_token">
            <column name="id" type="INT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="token" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="expires_at" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="used" type="BOOLEAN"/>
            <column name="user_id" type="INT">
                <constraints foreignKeyName="fk_pwdtoken_user" referencedTableName="user" referencedColumnNames="id"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="11-create-audit-log-table" author="dev">
        <createTable tableName="audit_log">
            <column name="id" type="INT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="action" type="VARCHAR(255)"/>
            <column name="description" type="TEXT"/>
            <column name="ip" type="VARCHAR(45)"/>
            <column name="ua" type="TEXT"/>
            <column name="realm_id" type="INT">
                <constraints foreignKeyName="fk_audit_realm" referencedTableName="realm" referencedColumnNames="id"/>
            </column>
            <column name="user_id" type="INT">
                <constraints foreignKeyName="fk_audit_user" referencedTableName="user" referencedColumnNames="id"/>
            </column>
        </createTable>
    </changeSet>

    <!-- ======================================== -->
    <!--  INITIAL DATA                            -->
    <!-- ======================================== -->

    <changeSet id="12-insert-roles" author="dev">
        <insert tableName="role">
            <column name="name" value="ADMIN"/>
            <column name="description" value="Realm administrator with elevated privileges"/>
        </insert>
        <insert tableName="role">
            <column name="name" value="SUPER_ADMIN"/>
            <column name="description" value="System-wide administrator with highest privileges"/>
        </insert>
        <insert tableName="role">
            <column name="name" value="REALM_ADMIN"/>
            <column name="description" value="Realm owner and manager"/>
        </insert>
        <insert tableName="role">
            <column name="name" value="USER"/>
            <column name="description" value="Standard user with limited access"/>
        </insert>
    </changeSet>

    <changeSet id="13-insert-plans" author="dev">
        <insert tableName="plan">
            <column name="name" value="Free"/>
            <column name="description" value="Basic plan with limited features"/>
            <column name="price" valueNumeric="0.00"/>
            <column name="max_users" valueNumeric="3"/>
            <column name="max_realms" valueNumeric="1"/>
            <column name="features" value="Basic support, Limited analytics"/>
        </insert>
        <insert tableName="plan">
            <column name="name" value="Pro"/>
            <column name="description" value="Professional plan with advanced features"/>
            <column name="price" valueNumeric="29.99"/>
            <column name="max_users" valueNumeric="10"/>
            <column name="max_realms" valueNumeric="5"/>
            <column name="features" value="Advanced analytics, Priority support"/>
        </insert>
        <insert tableName="plan">
            <column name="name" value="Enterprise"/>
            <column name="description" value="Enterprise plan with full features and support"/>
            <column name="price" valueNumeric="99.99"/>
            <column name="max_users" valueNumeric="100"/>
            <column name="max_realms" valueNumeric="50"/>
            <column name="features" value="Dedicated account manager, Custom integrations"/>
        </insert>
    </changeSet>

</databaseChangeLog>
